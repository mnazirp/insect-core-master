(window.webpackJsonp=window.webpackJsonp||[]).push([[17],{Ag5H:function(e,t,a){"use strict";a.r(t),a.d(t,"ExportSensorModule",(function(){return B}));var i=a("ofXK"),o=a("5HBU"),n=a("sYmb"),s=a("FtGj"),c=a("3Pt+"),r=a("1yaQ"),l=a("FKr1"),d=a("wd/R");const b={lang:"en",data:{SAMPLE:{HELLO:"Hello, World!"},FORM_FIELD:{LABEL:{DATE_RANGE:"Enter a date range",DATABASE:"Database",SITE:"Site",LOCATION:"Location",EXPORT:"Export"},DATE_PICKER:{TITLE:{DATE_RANGE:"Date Range: "}},INPUT:{PLACEHOLDER:{SEARCH_FOR_FORM:"Search for form",START_DATE:"Start date",END_DATE:"End date",SITE:"Enter site separated by comma with space behind, eg: site1, site2",LOCATION:"Enter location separated by comma with space behind, eg: location1, location2"}},SELECT:{OPTION:{CSV:"Export CSV",SHEET:"Export to Google Sheet"}},HINT:{EXAMPLE:"eg:"}},BUTTON:{EXPORT:"Export"}}},h={lang:"my",data:{SAMPLE:{HELLO:"Hello, World!"},FORM_FIELD:{LABEL:{DATE_RANGE:"Masukkan julat tarikh",DATABASE:"Pangkalan data",SITE:"Tapak",LOCATION:"Lokasi",EXPORT:"Eksport"},DATE_PICKER:{TITLE:{DATE_RANGE:"Julat Tarikh: "}},INPUT:{PLACEHOLDER:{SEARCH_FOR_FORM:"Cari borang",START_DATE:"Tarikh mula",END_DATE:"Tarikh tamat",SITE:"Masukkan tapak yang dipisahkan dengan koma dengan ruang di belakang, misalnya: site1, site2",LOCATION:"Masukkan lokasi dengan dipisahkan dengan koma dengan ruang di belakang, misalnya: location1, location2"}},SELECT:{OPTION:{CSV:"Eksport CSV",SHEET:"Eksport ke Google Sheet"}},HINT:{EXAMPLE:"Misalnya:"}},BUTTON:{EXPORT:"Eksport"}}};var p=a("fXoL"),u=a("tk/3");let m=(()=>{class e{constructor(e){this.http=e}exportCsv(e){return this.http.post("/api/export",e,{responseType:"text"})}}return e.\u0275fac=function(t){return new(t||e)(p.Yb(u.b))},e.\u0275prov=p.Kb({token:e,factory:e.\u0275fac,providedIn:"root"}),e})();var f=a("gPJw"),T=a("dNgK"),v=a("4WDQ"),g=a("tyNb"),E=a("XiUz"),D=a("kmnG"),L=a("iadO"),C=a("A5z7"),O=a("/1cH"),F=a("d3UM"),M=a("bTqV"),I=a("qFsG"),y=a("NFeN");const A=["deviceInput"],x=["auto"];function P(e,t){if(1&e){const e=p.Vb();p.Ub(0,"div",5),p.Ub(1,"mat-form-field",6),p.Ub(2,"mat-label"),p.Lc(3),p.hc(4,"translate"),p.Tb(),p.Ub(5,"input",25),p.cc("ngModelChange",(function(t){return p.yc(e),p.gc().selectedSite=t})),p.hc(6,"translate"),p.Tb(),p.Ub(7,"mat-hint"),p.Lc(8),p.hc(9,"translate"),p.Tb(),p.Tb(),p.Tb()}if(2&e){const e=p.gc();p.Cb(3),p.Mc(p.ic(4,4,"FORM_FIELD.LABEL.SITE")),p.Cb(2),p.oc("placeholder",p.ic(6,6,"FORM_FIELD.INPUT.PLACEHOLDER.SITE")),p.nc("ngModel",e.selectedSite),p.Cb(3),p.Nc("",p.ic(9,8,"FORM_FIELD.HINT.EXAMPLE")," site1, site2")}}function U(e,t){if(1&e){const e=p.Vb();p.Ub(0,"div",5),p.Ub(1,"mat-form-field",6),p.Ub(2,"mat-label"),p.Lc(3),p.hc(4,"translate"),p.Tb(),p.Ub(5,"input",25),p.cc("ngModelChange",(function(t){return p.yc(e),p.gc().selectedLocation=t})),p.hc(6,"translate"),p.Tb(),p.Ub(7,"mat-hint"),p.Lc(8),p.hc(9,"translate"),p.Tb(),p.Tb(),p.Tb()}if(2&e){const e=p.gc();p.Cb(3),p.Mc(p.ic(4,4,"FORM_FIELD.LABEL.LOCATION")),p.Cb(2),p.oc("placeholder",p.ic(6,6,"FORM_FIELD.INPUT.PLACEHOLDER.LOCATION")),p.nc("ngModel",e.selectedLocation),p.Cb(3),p.Nc("",p.ic(9,8,"FORM_FIELD.HINT.EXAMPLE")," location1, location2")}}function _(e,t){1&e&&(p.Ub(0,"mat-icon",28),p.Lc(1,"cancel"),p.Tb())}function R(e,t){if(1&e){const e=p.Vb();p.Ub(0,"mat-chip",26),p.cc("removed",(function(){p.yc(e);const a=t.$implicit;return p.gc().remove(a)})),p.Lc(1),p.Jc(2,_,2,0,"mat-icon",27),p.Tb()}if(2&e){const e=t.$implicit,a=p.gc();p.nc("selectable",a.selectable)("removable",a.removable),p.Cb(1),p.Nc(" ",e," "),p.Cb(1),p.nc("ngIf",a.removable)}}function N(e,t){if(1&e){const e=p.Vb();p.Ub(0,"mat-option",29),p.Ub(1,"div",30),p.cc("click",(function(a){p.yc(e);const i=t.$implicit;return p.gc().optionClicked(a,i)})),p.Lc(2),p.Tb(),p.Tb()}if(2&e){const e=t.$implicit;p.nc("value",e.value),p.Cb(2),p.Nc(" ",e.label," ")}}const k={parse:{dateInput:"LL"},display:{dateInput:"DD/MMM/YYYY",monthYearLabel:"MMM YYYY",dateA11yLabel:"LL",monthYearA11yLabel:"MMMM YYYY"}};let S=(()=>{class e{constructor(e,t,a,i,o,n){this._exportService=e,this._fuseTranslationLoaderService=t,this.snackBar=a,this.http=i,this.global=o,this.activatedRoute=n,this.exportType="GSheet",this.selectedSite="Chang Chun Pilot Johor",this.database="environmentdata",this.fields="",this.sorts="ts:desc",this.filterForm=this.getFilterForm(),this.provisionedDevices=[],this.provisionedDevicesFiltered=[],this.selectedDevice=[],this.selectable=!0,this.removable=!0,this.separatorKeysCodes=[s.g,s.c],this.deviceFromQueryParams=[],this._fuseTranslationLoaderService.loadTranslations(b,h)}ngOnInit(){this.setQueryParams(),this.fetchProvisionedDevices(),this.filterForm.get("ID_filter").valueChanges.subscribe(e=>{this.filterOptions(e)})}setQueryParams(){this.activatedRoute.queryParamMap.subscribe(e=>{this.deviceFromQueryParams=e.getAll("device")})}fetchProvisionedDevices(){this.http.get(`/api/${this.global.tenant}/options`,{params:{type:"export-provisioned-devices"}}).subscribe(e=>{this.provisionedDevices=e,this.provisionedDevicesFiltered=e,this.addDeviceFromQueryParams()},e=>{})}addDeviceFromQueryParams(){let e=this.provisionedDevices.filter(e=>this.deviceFromQueryParams.includes(e.value));for(const t of e)this.selectedDevice.push(t.label)}filterOptions(e){this.provisionedDevicesFiltered=this.provisionedDevices.filter(t=>{let a="",i=t.value;return"string"==typeof t.label&&(a=t.label),a.toLocaleLowerCase().indexOf(e.toLocaleLowerCase())>-1||i.toLocaleLowerCase().indexOf(e.toLocaleLowerCase())>-1})}getFilterForm(){return new c.k({ID:new c.h(null),ID_filter:new c.h})}generateBody(){let e="",t=this.selectedLocation?this.selectedLocation.split(", "):[];this.selectedLocation=t.join(","),t=this.selectedLocation.split(","),e=t.length>1?e+"location in "+this.selectedLocation:e+"location="+this.selectedLocation,null!=this.startDate&&(e=e+", ts>="+this.startDate.startOf("day").utcOffset("+8").unix(),null!=this.endDate&&(e=e+", ts<="+this.endDate.endOf("day").utcOffset("+8").unix()));let a=`${this.selectedSite}_${this.selectedLocation}`,i="";null!=this.startDate&&(i=""+this.startDate.format("yyMMDD"),null!=this.endDate&&(i=i+"-"+this.endDate.format("yyMMDD")),a=i+a);let o={location:t},n=[];this.selectedDevice.forEach(e=>{this.provisionedDevices.forEach(t=>{t.label==e&&n.push(t.value)})}),this.filterForm.get("ID").setValue(n);let s={filename:this.getFileName(),type:this.exportType,database:this.database,selectors:e,fields:this.fields,sort:this.sorts,filters:o,query:this.getCloudantQuery()};Object.assign(s.filters,this.filterForm.value),this._exportService.exportCsv(s).subscribe(e=>{this.snackBar.open("Exporting Data","Close",{duration:2e3}),this.filterForm.get("ID").reset()},e=>{this.snackBar.open(e.error,"OK",{duration:6e3})})}getFileName(){let e="",t=this.formatForFileName(this.startDate),a=this.formatForFileName(this.endDate),i=d().format("yyMMDD"),o=d().format("HHmmss");return e+="iot",e=e+"_"+this.exportType,e=e+"_"+t,a&&(e=e+"_"+a),e=e+"_"+i,e=e+"_"+o,e}getDeviceAliasForFileName(){let e=this.filterForm.value.ID||[],t=[];for(const a of e){let e=this.provisionedDevices.find(e=>e.value==a);t.push(e.label)}return t.join(",")}getCloudantQuery(){let e={};return e={selector:{ts:{$gte:this.formatToUnix(this.startDate.startOf("day")),$lte:this.formatToUnix(this.endDate.endOf("day"))},ID:{$in:this.filterForm.value.ID}},sort:[{ts:"desc"}]},e}formatForFileName(e){let t="";return e&&(t=e.format("yyMMDD")),t}formatToUnix(e){return e.utcOffset("+8").unix()}remove(e){const t=this.selectedDevice.indexOf(e);t>=0&&this.selectedDevice.splice(t,1)}selected(e){let t=e;this.selectedDevice.includes(t)||this.selectedDevice.push(t),this.deviceInput.nativeElement.value="",this.provisionedDevicesFiltered=this.provisionedDevices}get selectedAtLeastOneDevice(){return this.selectedDevice.length>0}add(e){const t=e.input,a=e.value;(a||"").trim()&&this.selectedDevice.push(a.trim()),t&&(t.value=""),this.provisionedDevicesFiltered=this.provisionedDevices}optionClicked(e,t){e.stopPropagation(),this.selected(t.label)}}return e.\u0275fac=function(t){return new(t||e)(p.Ob(m),p.Ob(f.a),p.Ob(T.a),p.Ob(u.b),p.Ob(v.a),p.Ob(g.a))},e.\u0275cmp=p.Ib({type:e,selectors:[["app-export-sensor"]],viewQuery:function(e,t){var a;1&e&&(p.Qc(A,!0),p.Qc(x,!0)),2&e&&(p.tc(a=p.dc())&&(t.deviceInput=a.first),p.tc(a=p.dc())&&(t.matAutocomplete=a.first))},features:[p.Bb([{provide:l.c,useClass:r.c,deps:[l.f,r.a]},{provide:l.e,useValue:k}])],decls:52,vars:41,consts:[[1,"page-layout","simple","fullwidth"],[1,"content","p-24"],["fxLayout","row",2,"padding","5%"],["fxLayout","column","fxFlex","100"],["fxLayout","column","fxFlex","",1,"ml-sm-32"],["fxLayout","row"],["appearance","outline",2,"width","100%"],[3,"rangePicker"],["tabindex","-1","readonly","","matStartDate","",3,"ngModel","placeholder","ngModelChange"],["tabindex","-1","readonly","","matEndDate","",3,"ngModel","placeholder","ngModelChange"],["matSuffix","",3,"for"],["picker",""],["fxLayout","row",4,"ngIf"],["fxLayout","row",3,"formGroup"],["appearance","outline","fxFlex",""],["chipList",""],[3,"selectable","removable","removed",4,"ngFor","ngForOf"],["placeholder","Device","formControlName","ID_filter",3,"matAutocomplete","matChipInputFor","matChipInputSeparatorKeyCodes"],["deviceInput",""],["auto","matAutocomplete"],[3,"value",4,"ngFor","ngForOf"],["name","export",3,"ngModel","ngModelChange"],["value","csv"],["value","GSheet"],["mat-raised-button","","color","accent","fxFlex","10",3,"disabled","click"],["matInput","",3,"ngModel","placeholder","ngModelChange"],[3,"selectable","removable","removed"],["matChipRemove","",4,"ngIf"],["matChipRemove",""],[3,"value"],[3,"click"]],template:function(e,t){if(1&e&&(p.Ub(0,"div",0),p.Ub(1,"div",1),p.Ub(2,"div",2),p.Ub(3,"div",3),p.Ub(4,"div",4),p.Ub(5,"h3"),p.Lc(6),p.hc(7,"translate"),p.Tb(),p.Ub(8,"div",5),p.Ub(9,"mat-form-field",6),p.Ub(10,"mat-label"),p.Lc(11),p.hc(12,"translate"),p.Tb(),p.Ub(13,"mat-date-range-input",7),p.Ub(14,"input",8),p.cc("ngModelChange",(function(e){return t.startDate=e})),p.hc(15,"translate"),p.Tb(),p.Ub(16,"input",9),p.cc("ngModelChange",(function(e){return t.endDate=e})),p.hc(17,"translate"),p.Tb(),p.Tb(),p.Pb(18,"mat-datepicker-toggle",10),p.Pb(19,"mat-date-range-picker",null,11),p.Tb(),p.Tb(),p.Jc(21,P,10,10,"div",12),p.Jc(22,U,10,10,"div",12),p.Ub(23,"div",13),p.Ub(24,"mat-form-field",14),p.Ub(25,"mat-label"),p.Lc(26),p.hc(27,"translate"),p.Tb(),p.Ub(28,"mat-chip-list",null,15),p.Jc(30,R,3,4,"mat-chip",16),p.Pb(31,"input",17,18),p.Tb(),p.Ub(33,"mat-autocomplete",null,19),p.Jc(35,N,3,2,"mat-option",20),p.Tb(),p.Tb(),p.Tb(),p.Ub(36,"div",5),p.Ub(37,"mat-form-field",6),p.Ub(38,"mat-label"),p.Lc(39),p.hc(40,"translate"),p.Tb(),p.Ub(41,"mat-select",21),p.cc("ngModelChange",(function(e){return t.exportType=e})),p.Ub(42,"mat-option",22),p.Lc(43),p.hc(44,"translate"),p.Tb(),p.Ub(45,"mat-option",23),p.Lc(46),p.hc(47,"translate"),p.Tb(),p.Tb(),p.Tb(),p.Tb(),p.Ub(48,"div",5),p.Ub(49,"button",24),p.cc("click",(function(){return t.generateBody()})),p.Lc(50),p.hc(51,"translate"),p.Tb(),p.Tb(),p.Tb(),p.Tb(),p.Tb(),p.Tb(),p.Tb()),2&e){const e=p.uc(20),a=p.uc(29),i=p.uc(34);p.Cb(6),p.Mc(p.ic(7,23,"FORM_FIELD.DATE_PICKER.TITLE.DATE_RANGE")),p.Cb(5),p.Mc(p.ic(12,25,"FORM_FIELD.LABEL.DATE_RANGE")),p.Cb(2),p.nc("rangePicker",e),p.Cb(1),p.oc("placeholder",p.ic(15,27,"FORM_FIELD.INPUT.PLACEHOLDER.START_DATE")),p.nc("ngModel",t.startDate),p.Cb(2),p.oc("placeholder",p.ic(17,29,"FORM_FIELD.INPUT.PLACEHOLDER.END_DATE")),p.nc("ngModel",t.endDate),p.Cb(2),p.nc("for",e),p.Cb(3),p.nc("ngIf",!1),p.Cb(1),p.nc("ngIf",!1),p.Cb(1),p.nc("formGroup",t.filterForm),p.Cb(3),p.Mc(p.ic(27,31,"Devices")),p.Cb(4),p.nc("ngForOf",t.selectedDevice),p.Cb(1),p.nc("matAutocomplete",i)("matChipInputFor",a)("matChipInputSeparatorKeyCodes",t.separatorKeysCodes),p.Cb(4),p.nc("ngForOf",t.provisionedDevicesFiltered),p.Cb(4),p.Mc(p.ic(40,33,"FORM_FIELD.LABEL.EXPORT")),p.Cb(2),p.nc("ngModel",t.exportType),p.Cb(2),p.Nc(" ",p.ic(44,35,"FORM_FIELD.SELECT.OPTION.CSV")," "),p.Cb(3),p.Nc(" ",p.ic(47,37,"FORM_FIELD.SELECT.OPTION.SHEET")," "),p.Cb(3),p.nc("disabled",!(t.startDate&&t.endDate&&t.selectedSite&&t.database&&t.exportType&&t.selectedAtLeastOneDevice)),p.Cb(1),p.Nc(" ",p.ic(51,39,"BUTTON.EXPORT")," ")}},directives:[E.c,E.a,D.c,D.g,L.d,L.l,c.d,c.s,c.v,L.k,L.j,D.i,L.e,i.t,c.t,c.l,C.c,i.s,O.c,C.b,c.j,O.a,F.a,l.o,M.b,I.b,D.f,C.a,y.a,C.d],pipes:[n.c],styles:[".search-wrapper[_ngcontent-%COMP%]{background-color:#fff;width:100%;max-width:480px;border-radius:28px;overflow:hidden;box-shadow:0 2px 1px -1px rgba(0,0,0,.2),0 1px 1px 0 rgba(0,0,0,.14),0 1px 3px 0 rgba(0,0,0,.12)}.search-wrapper[_ngcontent-%COMP%]   .search[_ngcontent-%COMP%]{width:100%;height:48px;line-height:48px;padding:0 18px}.search-wrapper[_ngcontent-%COMP%]   .search[_ngcontent-%COMP%]   input[_ngcontent-%COMP%]{width:100%;height:48px;min-height:48px;max-height:48px;padding:0 16px;border:none;outline:none}"]}),e})();var w=a("WJ5W");const H=[{path:"",component:S}];let B=(()=>{class e{}return e.\u0275mod=p.Mb({type:e}),e.\u0275inj=p.Lb({factory:function(t){return new(t||e)},imports:[[i.c,g.l.forChild(H),n.b,o.a,w.b,O.b,y.b,L.i,D.e,I.c,F.b,M.c,C.e]]}),e})()}}]);