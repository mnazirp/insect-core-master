!function(){function e(e,a){var n;if("undefined"==typeof Symbol||null==e[Symbol.iterator]){if(Array.isArray(e)||(n=function(e,a){if(!e)return;if("string"==typeof e)return t(e,a);var n=Object.prototype.toString.call(e).slice(8,-1);"Object"===n&&e.constructor&&(n=e.constructor.name);if("Map"===n||"Set"===n)return Array.from(e);if("Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return t(e,a)}(e))||a&&e&&"number"==typeof e.length){n&&(e=n);var i=0,o=function(){};return{s:o,n:function(){return i>=e.length?{done:!0}:{done:!1,value:e[i++]}},e:function(e){throw e},f:o}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var r,c=!0,s=!1;return{s:function(){n=e[Symbol.iterator]()},n:function(){var e=n.next();return c=e.done,e},e:function(e){s=!0,r=e},f:function(){try{c||null==n.return||n.return()}finally{if(s)throw r}}}}function t(e,t){(null==t||t>e.length)&&(t=e.length);for(var a=0,n=new Array(t);a<t;a++)n[a]=e[a];return n}function a(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function n(e,t){for(var a=0;a<t.length;a++){var n=t[a];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}function i(e,t,a){return t&&n(e.prototype,t),a&&n(e,a),e}(window.webpackJsonp=window.webpackJsonp||[]).push([[17],{Ag5H:function(t,n,o){"use strict";o.r(n),o.d(n,"ExportSensorModule",(function(){return K}));var r,c=o("ofXK"),s=o("5HBU"),l=o("sYmb"),u=o("FtGj"),d=o("3Pt+"),b=o("1yaQ"),f=o("FKr1"),h=o("wd/R"),p={lang:"en",data:{SAMPLE:{HELLO:"Hello, World!"},FORM_FIELD:{LABEL:{DATE_RANGE:"Enter a date range",DATABASE:"Database",SITE:"Site",LOCATION:"Location",EXPORT:"Export"},DATE_PICKER:{TITLE:{DATE_RANGE:"Date Range: "}},INPUT:{PLACEHOLDER:{SEARCH_FOR_FORM:"Search for form",START_DATE:"Start date",END_DATE:"End date",SITE:"Enter site separated by comma with space behind, eg: site1, site2",LOCATION:"Enter location separated by comma with space behind, eg: location1, location2"}},SELECT:{OPTION:{CSV:"Export CSV",SHEET:"Export to Google Sheet"}},HINT:{EXAMPLE:"eg:"}},BUTTON:{EXPORT:"Export"}}},v={lang:"my",data:{SAMPLE:{HELLO:"Hello, World!"},FORM_FIELD:{LABEL:{DATE_RANGE:"Masukkan julat tarikh",DATABASE:"Pangkalan data",SITE:"Tapak",LOCATION:"Lokasi",EXPORT:"Eksport"},DATE_PICKER:{TITLE:{DATE_RANGE:"Julat Tarikh: "}},INPUT:{PLACEHOLDER:{SEARCH_FOR_FORM:"Cari borang",START_DATE:"Tarikh mula",END_DATE:"Tarikh tamat",SITE:"Masukkan tapak yang dipisahkan dengan koma dengan ruang di belakang, misalnya: site1, site2",LOCATION:"Masukkan lokasi dengan dipisahkan dengan koma dengan ruang di belakang, misalnya: location1, location2"}},SELECT:{OPTION:{CSV:"Eksport CSV",SHEET:"Eksport ke Google Sheet"}},HINT:{EXAMPLE:"Misalnya:"}},BUTTON:{EXPORT:"Eksport"}}},m=o("fXoL"),T=o("tk/3"),g=((r=function(){function e(t){a(this,e),this.http=t}return i(e,[{key:"exportCsv",value:function(e){return this.http.post("/api/export",e,{responseType:"text"})}}]),e}()).\u0275fac=function(e){return new(e||r)(m.Yb(T.b))},r.\u0275prov=m.Kb({token:r,factory:r.\u0275fac,providedIn:"root"}),r),E=o("gPJw"),D=o("dNgK"),L=o("4WDQ"),y=o("tyNb"),C=o("XiUz"),O=o("kmnG"),F=o("iadO"),M=o("A5z7"),I=o("/1cH"),A=o("d3UM"),k=o("bTqV"),x=o("qFsG"),P=o("NFeN"),U=["deviceInput"],S=["auto"];function _(e,t){if(1&e){var a=m.Vb();m.Ub(0,"div",5),m.Ub(1,"mat-form-field",6),m.Ub(2,"mat-label"),m.Lc(3),m.hc(4,"translate"),m.Tb(),m.Ub(5,"input",25),m.cc("ngModelChange",(function(e){return m.yc(a),m.gc().selectedSite=e})),m.hc(6,"translate"),m.Tb(),m.Ub(7,"mat-hint"),m.Lc(8),m.hc(9,"translate"),m.Tb(),m.Tb(),m.Tb()}if(2&e){var n=m.gc();m.Cb(3),m.Mc(m.ic(4,4,"FORM_FIELD.LABEL.SITE")),m.Cb(2),m.oc("placeholder",m.ic(6,6,"FORM_FIELD.INPUT.PLACEHOLDER.SITE")),m.nc("ngModel",n.selectedSite),m.Cb(3),m.Nc("",m.ic(9,8,"FORM_FIELD.HINT.EXAMPLE")," site1, site2")}}function R(e,t){if(1&e){var a=m.Vb();m.Ub(0,"div",5),m.Ub(1,"mat-form-field",6),m.Ub(2,"mat-label"),m.Lc(3),m.hc(4,"translate"),m.Tb(),m.Ub(5,"input",25),m.cc("ngModelChange",(function(e){return m.yc(a),m.gc().selectedLocation=e})),m.hc(6,"translate"),m.Tb(),m.Ub(7,"mat-hint"),m.Lc(8),m.hc(9,"translate"),m.Tb(),m.Tb(),m.Tb()}if(2&e){var n=m.gc();m.Cb(3),m.Mc(m.ic(4,4,"FORM_FIELD.LABEL.LOCATION")),m.Cb(2),m.oc("placeholder",m.ic(6,6,"FORM_FIELD.INPUT.PLACEHOLDER.LOCATION")),m.nc("ngModel",n.selectedLocation),m.Cb(3),m.Nc("",m.ic(9,8,"FORM_FIELD.HINT.EXAMPLE")," location1, location2")}}function N(e,t){1&e&&(m.Ub(0,"mat-icon",28),m.Lc(1,"cancel"),m.Tb())}function w(e,t){if(1&e){var a=m.Vb();m.Ub(0,"mat-chip",26),m.cc("removed",(function(){m.yc(a);var e=t.$implicit;return m.gc().remove(e)})),m.Lc(1),m.Jc(2,N,2,0,"mat-icon",27),m.Tb()}if(2&e){var n=t.$implicit,i=m.gc();m.nc("selectable",i.selectable)("removable",i.removable),m.Cb(1),m.Nc(" ",n," "),m.Cb(1),m.nc("ngIf",i.removable)}}function H(e,t){if(1&e){var a=m.Vb();m.Ub(0,"mat-option",29),m.Ub(1,"div",30),m.cc("click",(function(e){m.yc(a);var n=t.$implicit;return m.gc().optionClicked(e,n)})),m.Lc(2),m.Tb(),m.Tb()}if(2&e){var n=t.$implicit;m.nc("value",n.value),m.Cb(2),m.Nc(" ",n.label," ")}}var B,Y,G={parse:{dateInput:"LL"},display:{dateInput:"DD/MMM/YYYY",monthYearLabel:"MMM YYYY",dateA11yLabel:"LL",monthYearA11yLabel:"MMMM YYYY"}},Q=((B=function(){function t(e,n,i,o,r,c){a(this,t),this._exportService=e,this._fuseTranslationLoaderService=n,this.snackBar=i,this.http=o,this.global=r,this.activatedRoute=c,this.exportType="GSheet",this.selectedSite="Chang Chun Pilot Johor",this.database="environmentdata",this.fields="",this.sorts="ts:desc",this.filterForm=this.getFilterForm(),this.provisionedDevices=[],this.provisionedDevicesFiltered=[],this.selectedDevice=[],this.selectable=!0,this.removable=!0,this.separatorKeysCodes=[u.g,u.c],this.deviceFromQueryParams=[],this._fuseTranslationLoaderService.loadTranslations(p,v)}return i(t,[{key:"ngOnInit",value:function(){var e=this;this.setQueryParams(),this.fetchProvisionedDevices(),this.filterForm.get("ID_filter").valueChanges.subscribe((function(t){e.filterOptions(t)}))}},{key:"setQueryParams",value:function(){var e=this;this.activatedRoute.queryParamMap.subscribe((function(t){e.deviceFromQueryParams=t.getAll("device")}))}},{key:"fetchProvisionedDevices",value:function(){var e=this;this.http.get("/api/".concat(this.global.tenant,"/options"),{params:{type:"export-provisioned-devices"}}).subscribe((function(t){e.provisionedDevices=t,e.provisionedDevicesFiltered=t,e.addDeviceFromQueryParams()}),(function(e){}))}},{key:"addDeviceFromQueryParams",value:function(){var t,a=this,n=e(this.provisionedDevices.filter((function(e){return a.deviceFromQueryParams.includes(e.value)})));try{for(n.s();!(t=n.n()).done;){var i=t.value;this.selectedDevice.push(i.label)}}catch(o){n.e(o)}finally{n.f()}}},{key:"filterOptions",value:function(e){this.provisionedDevicesFiltered=this.provisionedDevices.filter((function(t){var a="",n=t.value;return"string"==typeof t.label&&(a=t.label),a.toLocaleLowerCase().indexOf(e.toLocaleLowerCase())>-1||n.toLocaleLowerCase().indexOf(e.toLocaleLowerCase())>-1}))}},{key:"getFilterForm",value:function(){return new d.k({ID:new d.h(null),ID_filter:new d.h})}},{key:"generateBody",value:function(){var e=this,t="",a=this.selectedLocation?this.selectedLocation.split(", "):[];this.selectedLocation=a.join(","),t=(a=this.selectedLocation.split(",")).length>1?t+"location in "+this.selectedLocation:t+"location="+this.selectedLocation,null!=this.startDate&&(t=t+", ts>="+this.startDate.startOf("day").utcOffset("+8").unix(),null!=this.endDate&&(t=t+", ts<="+this.endDate.endOf("day").utcOffset("+8").unix()));var n="".concat(this.selectedSite,"_").concat(this.selectedLocation),i="";null!=this.startDate&&(i=""+this.startDate.format("yyMMDD"),null!=this.endDate&&(i=i+"-"+this.endDate.format("yyMMDD")),n=i+n);var o={location:a},r=[];this.selectedDevice.forEach((function(t){e.provisionedDevices.forEach((function(e){e.label==t&&r.push(e.value)}))})),this.filterForm.get("ID").setValue(r);var c={filename:this.getFileName(),type:this.exportType,database:this.database,selectors:t,fields:this.fields,sort:this.sorts,filters:o,query:this.getCloudantQuery()};Object.assign(c.filters,this.filterForm.value),this._exportService.exportCsv(c).subscribe((function(t){e.snackBar.open("Exporting Data","Close",{duration:2e3}),e.filterForm.get("ID").reset()}),(function(t){e.snackBar.open(t.error,"OK",{duration:6e3})}))}},{key:"getFileName",value:function(){var e="",t=this.formatForFileName(this.startDate),a=this.formatForFileName(this.endDate),n=h().format("yyMMDD"),i=h().format("HHmmss");return e=(e=(e+="iot")+"_"+this.exportType)+"_"+t,a&&(e=e+"_"+a),e=(e=e+"_"+n)+"_"+i}},{key:"getDeviceAliasForFileName",value:function(){var t,a=this,n=this.filterForm.value.ID||[],i=[],o=e(n);try{var r=function(){var e=t.value,n=a.provisionedDevices.find((function(t){return t.value==e}));i.push(n.label)};for(o.s();!(t=o.n()).done;)r()}catch(c){o.e(c)}finally{o.f()}return i.join(",")}},{key:"getCloudantQuery",value:function(){return{selector:{ts:{$gte:this.formatToUnix(this.startDate.startOf("day")),$lte:this.formatToUnix(this.endDate.endOf("day"))},ID:{$in:this.filterForm.value.ID}},sort:[{ts:"desc"}]}}},{key:"formatForFileName",value:function(e){var t="";return e&&(t=e.format("yyMMDD")),t}},{key:"formatToUnix",value:function(e){return e.utcOffset("+8").unix()}},{key:"remove",value:function(e){var t=this.selectedDevice.indexOf(e);t>=0&&this.selectedDevice.splice(t,1)}},{key:"selected",value:function(e){var t=e;this.selectedDevice.includes(t)||this.selectedDevice.push(t),this.deviceInput.nativeElement.value="",this.provisionedDevicesFiltered=this.provisionedDevices}},{key:"add",value:function(e){var t=e.input,a=e.value;(a||"").trim()&&this.selectedDevice.push(a.trim()),t&&(t.value=""),this.provisionedDevicesFiltered=this.provisionedDevices}},{key:"optionClicked",value:function(e,t){e.stopPropagation(),this.selected(t.label)}},{key:"selectedAtLeastOneDevice",get:function(){return this.selectedDevice.length>0}}]),t}()).\u0275fac=function(e){return new(e||B)(m.Ob(g),m.Ob(E.a),m.Ob(D.a),m.Ob(T.b),m.Ob(L.a),m.Ob(y.a))},B.\u0275cmp=m.Ib({type:B,selectors:[["app-export-sensor"]],viewQuery:function(e,t){var a;1&e&&(m.Qc(U,!0),m.Qc(S,!0)),2&e&&(m.tc(a=m.dc())&&(t.deviceInput=a.first),m.tc(a=m.dc())&&(t.matAutocomplete=a.first))},features:[m.Bb([{provide:f.c,useClass:b.c,deps:[f.f,b.a]},{provide:f.e,useValue:G}])],decls:52,vars:41,consts:[[1,"page-layout","simple","fullwidth"],[1,"content","p-24"],["fxLayout","row",2,"padding","5%"],["fxLayout","column","fxFlex","100"],["fxLayout","column","fxFlex","",1,"ml-sm-32"],["fxLayout","row"],["appearance","outline",2,"width","100%"],[3,"rangePicker"],["tabindex","-1","readonly","","matStartDate","",3,"ngModel","placeholder","ngModelChange"],["tabindex","-1","readonly","","matEndDate","",3,"ngModel","placeholder","ngModelChange"],["matSuffix","",3,"for"],["picker",""],["fxLayout","row",4,"ngIf"],["fxLayout","row",3,"formGroup"],["appearance","outline","fxFlex",""],["chipList",""],[3,"selectable","removable","removed",4,"ngFor","ngForOf"],["placeholder","Device","formControlName","ID_filter",3,"matAutocomplete","matChipInputFor","matChipInputSeparatorKeyCodes"],["deviceInput",""],["auto","matAutocomplete"],[3,"value",4,"ngFor","ngForOf"],["name","export",3,"ngModel","ngModelChange"],["value","csv"],["value","GSheet"],["mat-raised-button","","color","accent","fxFlex","10",3,"disabled","click"],["matInput","",3,"ngModel","placeholder","ngModelChange"],[3,"selectable","removable","removed"],["matChipRemove","",4,"ngIf"],["matChipRemove",""],[3,"value"],[3,"click"]],template:function(e,t){if(1&e&&(m.Ub(0,"div",0),m.Ub(1,"div",1),m.Ub(2,"div",2),m.Ub(3,"div",3),m.Ub(4,"div",4),m.Ub(5,"h3"),m.Lc(6),m.hc(7,"translate"),m.Tb(),m.Ub(8,"div",5),m.Ub(9,"mat-form-field",6),m.Ub(10,"mat-label"),m.Lc(11),m.hc(12,"translate"),m.Tb(),m.Ub(13,"mat-date-range-input",7),m.Ub(14,"input",8),m.cc("ngModelChange",(function(e){return t.startDate=e})),m.hc(15,"translate"),m.Tb(),m.Ub(16,"input",9),m.cc("ngModelChange",(function(e){return t.endDate=e})),m.hc(17,"translate"),m.Tb(),m.Tb(),m.Pb(18,"mat-datepicker-toggle",10),m.Pb(19,"mat-date-range-picker",null,11),m.Tb(),m.Tb(),m.Jc(21,_,10,10,"div",12),m.Jc(22,R,10,10,"div",12),m.Ub(23,"div",13),m.Ub(24,"mat-form-field",14),m.Ub(25,"mat-label"),m.Lc(26),m.hc(27,"translate"),m.Tb(),m.Ub(28,"mat-chip-list",null,15),m.Jc(30,w,3,4,"mat-chip",16),m.Pb(31,"input",17,18),m.Tb(),m.Ub(33,"mat-autocomplete",null,19),m.Jc(35,H,3,2,"mat-option",20),m.Tb(),m.Tb(),m.Tb(),m.Ub(36,"div",5),m.Ub(37,"mat-form-field",6),m.Ub(38,"mat-label"),m.Lc(39),m.hc(40,"translate"),m.Tb(),m.Ub(41,"mat-select",21),m.cc("ngModelChange",(function(e){return t.exportType=e})),m.Ub(42,"mat-option",22),m.Lc(43),m.hc(44,"translate"),m.Tb(),m.Ub(45,"mat-option",23),m.Lc(46),m.hc(47,"translate"),m.Tb(),m.Tb(),m.Tb(),m.Tb(),m.Ub(48,"div",5),m.Ub(49,"button",24),m.cc("click",(function(){return t.generateBody()})),m.Lc(50),m.hc(51,"translate"),m.Tb(),m.Tb(),m.Tb(),m.Tb(),m.Tb(),m.Tb(),m.Tb()),2&e){var a=m.uc(20),n=m.uc(29),i=m.uc(34);m.Cb(6),m.Mc(m.ic(7,23,"FORM_FIELD.DATE_PICKER.TITLE.DATE_RANGE")),m.Cb(5),m.Mc(m.ic(12,25,"FORM_FIELD.LABEL.DATE_RANGE")),m.Cb(2),m.nc("rangePicker",a),m.Cb(1),m.oc("placeholder",m.ic(15,27,"FORM_FIELD.INPUT.PLACEHOLDER.START_DATE")),m.nc("ngModel",t.startDate),m.Cb(2),m.oc("placeholder",m.ic(17,29,"FORM_FIELD.INPUT.PLACEHOLDER.END_DATE")),m.nc("ngModel",t.endDate),m.Cb(2),m.nc("for",a),m.Cb(3),m.nc("ngIf",!1),m.Cb(1),m.nc("ngIf",!1),m.Cb(1),m.nc("formGroup",t.filterForm),m.Cb(3),m.Mc(m.ic(27,31,"Devices")),m.Cb(4),m.nc("ngForOf",t.selectedDevice),m.Cb(1),m.nc("matAutocomplete",i)("matChipInputFor",n)("matChipInputSeparatorKeyCodes",t.separatorKeysCodes),m.Cb(4),m.nc("ngForOf",t.provisionedDevicesFiltered),m.Cb(4),m.Mc(m.ic(40,33,"FORM_FIELD.LABEL.EXPORT")),m.Cb(2),m.nc("ngModel",t.exportType),m.Cb(2),m.Nc(" ",m.ic(44,35,"FORM_FIELD.SELECT.OPTION.CSV")," "),m.Cb(3),m.Nc(" ",m.ic(47,37,"FORM_FIELD.SELECT.OPTION.SHEET")," "),m.Cb(3),m.nc("disabled",!(t.startDate&&t.endDate&&t.selectedSite&&t.database&&t.exportType&&t.selectedAtLeastOneDevice)),m.Cb(1),m.Nc(" ",m.ic(51,39,"BUTTON.EXPORT")," ")}},directives:[C.c,C.a,O.c,O.g,F.d,F.l,d.d,d.s,d.v,F.k,F.j,O.i,F.e,c.t,d.t,d.l,M.c,c.s,I.c,M.b,d.j,I.a,A.a,f.o,k.b,x.b,O.f,M.a,P.a,M.d],pipes:[l.c],styles:[".search-wrapper[_ngcontent-%COMP%]{background-color:#fff;width:100%;max-width:480px;border-radius:28px;overflow:hidden;box-shadow:0 2px 1px -1px rgba(0,0,0,.2),0 1px 1px 0 rgba(0,0,0,.14),0 1px 3px 0 rgba(0,0,0,.12)}.search-wrapper[_ngcontent-%COMP%]   .search[_ngcontent-%COMP%]{width:100%;height:48px;line-height:48px;padding:0 18px}.search-wrapper[_ngcontent-%COMP%]   .search[_ngcontent-%COMP%]   input[_ngcontent-%COMP%]{width:100%;height:48px;min-height:48px;max-height:48px;padding:0 16px;border:none;outline:none}"]}),B),X=o("WJ5W"),j=[{path:"",component:Q}],K=((Y=function e(){a(this,e)}).\u0275mod=m.Mb({type:Y}),Y.\u0275inj=m.Lb({factory:function(e){return new(e||Y)},imports:[[c.c,y.l.forChild(j),l.b,s.a,X.b,I.b,P.b,F.i,O.e,x.c,A.b,k.c,M.e]]}),Y)}}])}();